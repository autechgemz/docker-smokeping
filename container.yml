---
- hosts: all
  gather_facts: yes
  vars_files:
    - "vars/{{ ansible_distribution }}.yml"
  tasks:
  - name: smokeping configurations
    block:
    - name: generate httpd.conf
      template:
        src: "apache2/httpd.conf.j2"
        dest: "/etc/apache2/httpd.conf"
    - name: generate smokeping.conf
      copy:
        src: "apache2/smokeping.conf"
        dest: "/etc/apache2/conf.d/smokeping.conf"
    - name: generate smokeping config
      template:
        src: "smokeping/config.j2"
        dest: "/etc/smokeping/config"
    - name: make smokeping directories
      file:
        path: "/var/lib/smokeping/{{ item }}"
        owner: apache
        group: smokeping
        state: directory
      with_items:
        - cache
        - data
    - name: "make symlink to /dev/stdout"
      file:
        src: "/dev/stdout"
        dest: "/var/log/apache2/error.log"
        state: link
        follow: no
    - name: "make symlink to /dev/null"
      file:
        src: "/dev/null"
        dest: "/var/log/apache2/access.log"
        state: link
        follow: no
  - name: setup runit configrations
    block:
    - name: copy services directories
      copy:
        src: "services/"
        dest: "/services"
        owner: root
        group: root
        mode: 0755
    - name: set execute attribute
      file:
        path: "/services/{{ item }}/run"
      with_items:
        - "apache"
        - "smokeping"
